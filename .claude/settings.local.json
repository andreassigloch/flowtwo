{
  "permissions": {
    "allow": [
      "mcp__ruv-swarm",
      "mcp__claude-flow@alpha",
      "mcp__flow-nexus",
      "Bash(npx claude-flow@alpha sparc \"Implement CR-038 Clean Architecture Refactor for GraphEngine. \n\nOBJECTIVE: Fix degraded functionality in /analyze, /optimize, and change tracking by establishing single AgentDB instance per session with proper dependency injection.\n\nKEY PROBLEMS TO SOLVE:\n1. Multiple AgentDB instances (chat-interface, graph-viewer, rule-evaluator each create their own)\n2. /analyze returns nothing despite loaded graph with violations\n3. /optimize doesn''t see current data\n4. Change tracking indicators (+/-/~) don''t appear in graph viewer\n\nIMPLEMENTATION PHASES (in order):\nPhase 1: Fix Graph Viewer - Remove AgentDB from graph-viewer.ts, use WebSocket data directly\nPhase 2: Fix WebSocket Broadcast - Include nodeChangeStatus, workItemSummary, validationSummary in broadcasts\nPhase 3: Fix Evaluator Data Source - Remove singleton cache from unified-rule-evaluator.ts, accept AgentDB as parameter\nPhase 4: Background Validation - Create debounced validation handler (300ms)\nPhase 5: Session Manager - Create src/session-manager.ts as orchestrator that owns single AgentDB instance\nPhase 6: Variant Pool - Create copy-on-write variant pool for optimizer/evaluator isolation\nPhase 7: Self-Learning Integration - Connect ReflexionMemory and SkillLibrary to LLM flow\nPhase 8: Context Manager - Create task-specific graph slicing for token optimization\nPhase 9: Graph Canvas Controller Split - Separate interaction state from pure rendering\n\nFILES TO CREATE:\n- src/session-manager.ts (orchestrator)\n- src/llm-engine/agentdb/variant-pool.ts\n- src/llm-engine/validation/background-validator.ts\n- src/llm-engine/context-manager.ts\n- src/canvas/graph-canvas-controller.ts\n- src/canvas/graph-canvas-renderer.ts\n\nFILES TO MODIFY:\n- src/terminal-ui/graph-viewer.ts\n- src/terminal-ui/chat-interface.ts\n- src/llm-engine/validation/unified-rule-evaluator.ts\n- src/terminal-ui/commands/validation-commands.ts\n- src/main.ts\n\nACCEPTANCE CRITERIA:\n- /analyze detects violations on loaded graph\n- /optimize works with current data and uses Variant Pool\n- Diff indicators (+/-/~) show in graph viewer\n- /status shows correct change count\n- Only ONE AgentDB instance exists per session\n- All existing tests pass\n\nReference: docs/cr/CR-038-clean-architecture-refactor.md\" --claude)",
      "Bash(npx claude-flow@alpha:*)",
      "Bash(cat:*)",
      "Bash(grep:*)",
      "Bash(npm view:*)",
      "Bash(npm cache ls:*)",
      "Bash(npm cache:*)",
      "Bash(npm run build:*)",
      "Bash(npx vitest:*)",
      "Bash(find:*)",
      "Bash(npx tsx:*)",
      "Bash(mkdir -p:*)",
      "Bash(npm run test:e2e:smoke:*)",
      "Bash(npm run test:e2e:workflows:*)",
      "Bash(npm run test:e2e:*)",
      "Bash(timeout:*)",
      "Bash(brew install:*)",
      "Bash(source .env)",
      "Bash(cypher-shell:*)",
      "Bash(echo:*)",
      "Bash(source:*)",
      "Bash(nc:*)",
      "Bash(npx tsc:*)",
      "Bash(sort:*)",
      "Bash(mv:*)",
      "Bash(__NEW_LINE__ rm \"eval/cr-028-optimizer/fixtures/architectures/UrbanMobilityVehicle_converted 2.json\")",
      "Bash(rm:*)",
      "Bash(__NEW_LINE__ echo \"Deleted 11 identical duplicates\")",
      "Bash(/dev/null ls -la models/*.md)",
      "Bash(__NEW_LINE__ rm \"src/canvas/stateless-graph-canvas 2.ts\")",
      "Bash(__NEW_LINE__ echo \"Deleted 8 older duplicates, kept exports/graphengineCr38.formatE 2.md\")",
      "Bash(tail:*)",
      "Bash(chmod:*)",
      "Bash(STAGED_FILES=\"settings/ontology-rules.json\")",
      "Bash(bash -c '\nONTOLOGY_CHANGED=$(echo \"\"$STAGED_FILES\"\" | grep -c \"\"settings/ontology-rules.json\"\" || true)\necho \"\"ONTOLOGY_CHANGED: $ONTOLOGY_CHANGED\"\"\nif [ \"\"$ONTOLOGY_CHANGED\"\" -gt 0 ]; then\n  echo \"\"✅ Hook würde rule consistency check ausführen\"\"\n  npx tsx scripts/check-rule-consistency.ts\nfi\n')",
      "Skill(neo4j-query)",
      "Bash(gtimeout:*)",
      "Bash(__NEW_LINE__ echo \"\")",
      "Bash(README.md )",
      "Bash(docs/ARCHITECTURE.md )",
      "Bash(docs/requirements )",
      "Bash(docs/cr/CR-055-pre-apply-validation.md )",
      "Bash(src/llm-engine/validation/pre-apply-validator.ts )",
      "Bash(tests/unit/validation/pre-apply-validator.test.ts)"
    ],
    "deny": []
  }
}
